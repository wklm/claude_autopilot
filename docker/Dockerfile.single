# Claude Single Agent Monitor
FROM python:3.11-slim

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # Basic tools
    curl \
    git \
    wget \
    tmux \
    sudo \
    jq \
    # Build dependencies
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20 for Claude CLI
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Install claude-auto-resume for API quota handling (optional)
RUN git clone https://github.com/terryso/claude-auto-resume /opt/claude-auto-resume && \
    chmod +x /opt/claude-auto-resume/claude-auto-resume.sh && \
    ln -s /opt/claude-auto-resume/claude-auto-resume.sh /usr/local/bin/claude-auto-resume

# Create non-root user
RUN useradd -m -s /bin/bash claude && \
    echo "claude ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set up working directory
WORKDIR /app

# Copy requirements first for better caching
COPY pyproject.toml ./
COPY README.md ./

# Copy source code
COPY src/ ./src/

# Install Python dependencies
RUN pip install --no-cache-dir -e .

# Create directories for claude user
RUN mkdir -p /home/claude/.config && \
    mkdir -p /home/claude/workspace && \
    chown -R claude:claude /home/claude

# Copy entrypoint script
COPY docker/docker-entrypoint-single.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Switch to non-root user
USER claude

# Set up environment
ENV CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1
ENV CLAUDE_SINGLE_AGENT_DOCKER=1
ENV PYTHONUNBUFFERED=1

# Working directory for projects
WORKDIR /home/claude/workspace

# Entrypoint
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# Default command
CMD ["python", "-m", "claude_code_agent_farm.single_agent_cli"]